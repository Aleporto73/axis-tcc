module.exports=[93695,(e,t,a)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},18622,(e,t,a)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},23862,e=>e.a(async(t,a)=>{try{let t=await e.y("pg-587764f78a6c7a9c");e.n(t),a()}catch(e){a(e)}},!0),18636,e=>e.a(async(t,a)=>{try{var n=e.i(89171),r=e.i(23862),s=t([r]);[r]=s.then?(await s)():s;let d=new r.Pool({host:process.env.DATABASE_HOST,port:parseInt(process.env.DATABASE_PORT||"5432"),user:process.env.DATABASE_USER,password:process.env.DATABASE_PASSWORD,database:process.env.DATABASE_NAME}),c=process.env.GOOGLE_CLIENT_ID,u=process.env.GOOGLE_CLIENT_SECRET;async function o(e){let t=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:c,client_secret:u,refresh_token:e,grant_type:"refresh_token"})});return t.ok?(await t.json()).access_token:null}async function i(e,t){let a=await d.query("SELECT * FROM calendar_connections WHERE tenant_id = $1 AND provider = $2",[e,"google"]);if(0===a.rows.length)return;let n=a.rows[0],r=n.access_token;if(new Date(n.token_expiry)<new Date){if(!(r=await o(n.refresh_token)))return;await d.query("UPDATE calendar_connections SET access_token = $1, token_expiry = $2, updated_at = NOW() WHERE id = $3",[r,new Date(Date.now()+36e5),n.id])}let s=await d.query("SELECT sync_token FROM calendar_sync_state WHERE tenant_id = $1 AND provider = $2",[e,"google"]),i=s.rows[0]?.sync_token,l="https://www.googleapis.com/calendar/v3/calendars/primary/events?";if(i)l+="syncToken="+i;else{let e=new Date;e.setMonth(e.getMonth()-1),l+="singleEvents=true&maxResults=50&timeMin="+e.toISOString()}let c=await fetch(l,{headers:{Authorization:"Bearer "+r}});if(!c.ok){let e=await c.text();console.error("[WEBHOOK] Erro ao buscar eventos:",e);return}let u=await c.json(),p=u.items||[],g=0,h=0;for(let t of p){if(!t.start?.dateTime||!t.end?.dateTime)continue;let a=null,n=null;if(t.attendees&&t.attendees.length>0){for(let r of t.attendees)if(r.email&&!r.self){let t=await d.query("SELECT id FROM patients WHERE tenant_id = $1 AND email = $2",[e,r.email]);if(t.rows.length>0){a=t.rows[0].id,n=r.email;break}}}let r=t.hangoutLink||null,s=function(e,t){if(!e||!t)return"needsAction";let a=e.find(e=>e.email===t&&!e.self);return a&&a.responseStatus||"needsAction"}(t.attendees,n),o=await d.query("SELECT id, external_etag FROM sessions WHERE tenant_id = $1 AND google_event_id = $2",[e,t.id]);if(o.rows.length>0)o.rows[0].external_etag!==t.etag&&(await d.query(`UPDATE sessions SET 
            scheduled_at = $1, 
            duration_minutes = $2,
            status = $3,
            external_etag = $4,
            external_updated_at = $5,
            google_meet_link = $6,
            patient_response = $7
          WHERE id = $8`,[t.start.dateTime,Math.round((new Date(t.end.dateTime).getTime()-new Date(t.start.dateTime).getTime())/6e4),"cancelled"===t.status?"cancelada":"agendada",t.etag,t.updated,r,s,o.rows[0].id]),h++);else if(a&&"cancelled"!==t.status){let n=(await d.query("SELECT COALESCE(MAX(session_number), 0) + 1 as next FROM sessions WHERE patient_id = $1",[a])).rows[0].next;await d.query(`INSERT INTO sessions 
          (tenant_id, patient_id, session_number, scheduled_at, duration_minutes, status, 
           google_event_id, google_calendar_id, calendar_source, external_etag, external_updated_at, google_meet_link, patient_response)
        VALUES ($1, $2, $3, $4, $5, 'agendada', $6, 'primary', 'google', $7, $8, $9, $10)`,[e,a,n,t.start.dateTime,Math.round((new Date(t.end.dateTime).getTime()-new Date(t.start.dateTime).getTime())/6e4),t.id,t.etag,t.updated,r,s]),g++}}u.nextSyncToken&&await d.query(`INSERT INTO calendar_sync_state (tenant_id, user_id, provider, calendar_id, sync_token, last_sync_at)
      VALUES ($1, $2, 'google', 'primary', $3, NOW())
      ON CONFLICT (tenant_id, user_id, provider, calendar_id)
      DO UPDATE SET sync_token = $3, last_sync_at = NOW()`,[e,t,u.nextSyncToken]),console.log("[WEBHOOK] Sync concluido:",{tenantId:e,imported:g,updated:h})}async function l(e){try{let t=e.headers.get("x-goog-channel-id"),a=e.headers.get("x-goog-resource-state");if(console.log("[WEBHOOK] Recebido:",{channelId:t,resourceState:a}),"sync"===a)return n.NextResponse.json({status:"sync acknowledged"});if(!t)return n.NextResponse.json({error:"Missing channel ID"},{status:400});let r=await d.query("SELECT tenant_id, user_id FROM calendar_connections WHERE webhook_channel_id = $1",[t]);if(0===r.rows.length)return console.log("[WEBHOOK] Canal nao encontrado:",t),n.NextResponse.json({status:"channel not found"});let{tenant_id:s,user_id:o}=r.rows[0];return await i(s,o),n.NextResponse.json({status:"ok"})}catch(e){return console.error("[WEBHOOK] Erro:",e),n.NextResponse.json({error:"Internal error"},{status:500})}}e.s(["POST",()=>l]),a()}catch(e){a(e)}},!1),10897,e=>e.a(async(t,a)=>{try{var n=e.i(47909),r=e.i(74017),s=e.i(96250),o=e.i(59756),i=e.i(61916),l=e.i(74677),d=e.i(69741),c=e.i(16795),u=e.i(87718),p=e.i(95169),g=e.i(47587),h=e.i(66012),E=e.i(70101),_=e.i(26937),w=e.i(10372),R=e.i(93695);e.i(52474);var x=e.i(220),f=e.i(18636),y=t([f]);[f]=y.then?(await y)():y;let T=new n.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/google/webhook/route",pathname:"/api/google/webhook",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/google/webhook/route.ts",nextConfigOutput:"",userland:f}),{workAsyncStorage:A,workUnitAsyncStorage:O,serverHooks:S}=T;function m(){return(0,s.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:O})}async function v(e,t,a){T.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/google/webhook/route";n=n.replace(/\/index$/,"")||"/";let s=await T.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!s)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:f,params:y,nextConfig:m,parsedUrl:v,isDraftMode:A,prerenderManifest:O,routerServerContext:S,isOnDemandRevalidate:k,revalidateOnlyGenerated:C,resolvedPathname:N,clientReferenceManifest:$,serverActionsManifest:b}=s,D=(0,d.normalizeAppPath)(n),P=!!(O.dynamicRoutes[D]||O.routes[N]),H=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,v,!1):t.end("This page could not be found"),null);if(P&&!A){let e=!!O.routes[N],t=O.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(m.experimental.adapterPath)return await H();throw new R.NoFallbackError}}let q=null;!P||T.isDev||A||(q=N,q="/index"===q?"/":q);let I=!0===T.isDev||!P,M=P&&!I;b&&$&&(0,l.setManifestsSingleton)({page:n,clientReferenceManifest:$,serverActionsManifest:b});let j=e.method||"GET",U=(0,i.getTracer)(),L=U.getActiveScopeSpan(),W={params:y,prerenderManifest:O,renderOpts:{experimental:{authInterrupts:!!m.experimental.authInterrupts},cacheComponents:!!m.cacheComponents,supportsDynamicResponse:I,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:m.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n,r)=>T.onRequestError(e,t,n,r,S)},sharedContext:{buildId:f}},B=new c.NodeNextRequest(e),F=new c.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(B,(0,u.signalFromNodeResponse)(t));try{let s=async e=>T.handle(K,W).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=U.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${j} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${n}`)}),l=!!(0,o.getRequestMeta)(e,"minimalMode"),d=async o=>{var i,d;let c=async({previousCacheEntry:r})=>{try{if(!l&&k&&C&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(o);e.fetchMetrics=W.renderOpts.fetchMetrics;let i=W.renderOpts.pendingWaitUntil;i&&a.waitUntil&&(a.waitUntil(i),i=void 0);let d=W.renderOpts.collectedTags;if(!P)return await (0,h.sendResponse)(B,F,n,W.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,E.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[w.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==W.renderOpts.collectedRevalidate&&!(W.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&W.renderOpts.collectedRevalidate,r=void 0===W.renderOpts.collectedExpire||W.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:W.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==r?void 0:r.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:k})},!1,S),t}},u=await T.handleResponse({req:e,nextConfig:m,cacheKey:q,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:k,revalidateOnlyGenerated:C,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:l});if(!P)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",k?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,E.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&P||p.delete(w.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,_.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(B,F,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};L?await d(L):await U.withPropagatedContext(e.headers,()=>U.trace(p.BaseServerSpan.handleRequest,{spanName:`${j} ${n}`,kind:i.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},d))}catch(t){if(t instanceof R.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:k})},!1,S),P)throw t;return await (0,h.sendResponse)(B,F,new Response(null,{status:500})),null}}e.s(["handler",()=>v,"patchFetch",()=>m,"routeModule",()=>T,"serverHooks",()=>S,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>O]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__a40f1c43._.js.map