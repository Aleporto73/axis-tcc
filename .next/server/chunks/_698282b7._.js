module.exports=[69820,e=>e.a(async(t,a)=>{try{var n=e.i(15115),r=t([n]);async function s(e){let{tenant_id:t,session_id:a,patient_id:r,scheduled_at:s,patient_name:o}=e,i=await n.default.query("SELECT id FROM patient_push_tokens WHERE patient_id = $1 LIMIT 1",[r]);if(0===i.rows.length)return console.log(`[REMINDER] Paciente ${r} nao autorizou push - lembretes NAO agendados`),!1;await n.default.query("DELETE FROM scheduled_reminders WHERE session_id = $1",[a]);let l=new Date(s),d=new Date,u=0,c=new Date(l.getTime()-864e5);c>d&&(await n.default.query(`INSERT INTO scheduled_reminders 
       (tenant_id, session_id, patient_id, recipient_type, recipient_id, scheduled_time, title, message, reminder_type)
       VALUES ($1, $2, $3, 'patient', $3, $4, $5, $6, '24h')`,[t,a,r,c,"Lembrete de Sessao","Voce tem uma sessao amanha"]),u++);let p=new Date(l.getTime()-6e5);return p>d&&(await n.default.query(`INSERT INTO scheduled_reminders 
       (tenant_id, session_id, patient_id, recipient_type, recipient_id, scheduled_time, title, message, reminder_type)
       VALUES ($1, $2, $3, 'patient', $3, $4, $5, $6, '10m')`,[t,a,r,p,"Sessao em 10 minutos","Sua sessao comeca em breve"]),u++),console.log(`[REMINDER] ${u} lembretes agendados para paciente ${r} (sessao ${a})`),u>0}[n]=r.then?(await r)():r,e.s(["scheduleSessionReminders",()=>s]),a()}catch(e){a(e)}},!1),79453,e=>e.a(async(t,a)=>{try{var n=e.i(89171),r=e.i(7218),s=e.i(15115),o=e.i(69820),i=t([s,o]);[s,o]=i.then?(await i)():i;let c=process.env.GOOGLE_CLIENT_ID,p=process.env.GOOGLE_CLIENT_SECRET;async function l(e){let t=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:c,client_secret:p,refresh_token:e,grant_type:"refresh_token"})});return t.ok?(await t.json()).access_token:null}async function d(e,t,a,n,r=60){try{let o=await s.default.query("SELECT * FROM calendar_connections WHERE tenant_id = $1 AND provider = $2",[e,"google"]);if(0===o.rows.length)return null;let i=o.rows[0],d=i.access_token;if(new Date(i.token_expiry)<new Date){if(!(d=await l(i.refresh_token)))return null;await s.default.query("UPDATE calendar_connections SET access_token = $1, token_expiry = $2, updated_at = NOW() WHERE id = $3",[d,new Date(Date.now()+36e5),i.id])}let u=new Date(n.getTime()+60*r*1e3),c={summary:`Sessao - ${t}`,start:{dateTime:n.toISOString(),timeZone:"America/Sao_Paulo"},end:{dateTime:u.toISOString(),timeZone:"America/Sao_Paulo"},conferenceData:{createRequest:{requestId:`axis-${Date.now()}`,conferenceSolutionKey:{type:"hangoutsMeet"}}}};a&&(c.attendees=[{email:a}]);let p=await fetch("https://www.googleapis.com/calendar/v3/calendars/primary/events?conferenceDataVersion=1&sendUpdates=all",{method:"POST",headers:{Authorization:"Bearer "+d,"Content-Type":"application/json"},body:JSON.stringify(c)});if(!p.ok){let e=await p.text();return console.error("[GOOGLE_CREATE] Erro ao criar evento:",e),null}let h=await p.json();return console.log("[GOOGLE_CREATE] Evento criado:",h.id),{eventId:h.id,meetLink:h.hangoutLink||null}}catch(e){return console.error("[GOOGLE_CREATE] Erro:",e),null}}async function u(e){try{let t,{userId:a}=await (0,r.auth)();if(!a)return n.NextResponse.json({error:"Nao autenticado"},{status:401});let i=await s.default.query("SELECT id FROM tenants WHERE clerk_user_id = $1",[a]);if(0===i.rows.length)return n.NextResponse.json({error:"Tenant nao encontrado"},{status:404});let l=i.rows[0].id,{patient_id:u,session_type:c="presencial",scheduled_at:p,start_now:h=!0}=await e.json();if(!u)return n.NextResponse.json({error:"Paciente obrigatorio"},{status:400});let _=await s.default.query("SELECT full_name, email FROM patients WHERE id = $1 AND tenant_id = $2",[u,l]);if(0===_.rows.length)return n.NextResponse.json({error:"Paciente nao encontrado"},{status:404});let E=_.rows[0].full_name,m=_.rows[0].email,R=await s.default.query("SELECT COUNT(*) as total FROM sessions WHERE patient_id = $1",[u]),w=parseInt(R.rows[0].total)+1,g=null,f=null;if(h)t=await s.default.query(`INSERT INTO sessions (tenant_id, patient_id, session_type, session_number, scheduled_at, started_at, status, time_source)
         VALUES ($1, $2, $3, $4, NOW(), NOW(), 'em_andamento', 'manual')
         RETURNING id, patient_id, session_number, scheduled_at, started_at, status`,[l,u,c,w]);else{if(!p)return n.NextResponse.json({error:"Data de agendamento obrigatoria"},{status:400});let e=await d(l,E,m,new Date(p),60);e&&(g=e.eventId,f=e.meetLink),t=await s.default.query(`INSERT INTO sessions (tenant_id, patient_id, session_type, session_number, scheduled_at, started_at, status, time_source, google_event_id, google_calendar_id, calendar_source, google_meet_link)
         VALUES ($1, $2, $3, $4, $5, NULL, 'agendada', 'manual', $6, 'primary', $7, $8)
         RETURNING id, patient_id, session_number, scheduled_at, started_at, status, google_meet_link`,[l,u,c,w,p,g,g?"google":null,f]),await (0,o.scheduleSessionReminders)({tenant_id:l,session_id:t.rows[0].id,patient_id:u,scheduled_at:new Date(p),patient_name:E})||console.log("[SESSION] Paciente",u,"nao autorizou push - sem lembretes")}return n.NextResponse.json({success:!0,session:t.rows[0],google_synced:!!g},{status:201})}catch(e){return console.error("Erro ao criar sessao:",e),n.NextResponse.json({error:"Erro interno"},{status:500})}}e.s(["POST",()=>u]),a()}catch(e){a(e)}},!1),60572,e=>e.a(async(t,a)=>{try{var n=e.i(47909),r=e.i(74017),s=e.i(96250),o=e.i(59756),i=e.i(61916),l=e.i(74677),d=e.i(69741),u=e.i(16795),c=e.i(87718),p=e.i(95169),h=e.i(47587),_=e.i(66012),E=e.i(70101),m=e.i(26937),R=e.i(10372),w=e.i(93695);e.i(52474);var g=e.i(220),f=e.i(79453),y=t([f]);[f]=y.then?(await y)():y;let N=new n.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/sessions/create/route",pathname:"/api/sessions/create",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/sessions/create/route.ts",nextConfigOutput:"",userland:f}),{workAsyncStorage:S,workUnitAsyncStorage:O,serverHooks:$}=N;function T(){return(0,s.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:O})}async function v(e,t,a){N.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/sessions/create/route";n=n.replace(/\/index$/,"")||"/";let s=await N.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!s)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:f,params:y,nextConfig:T,parsedUrl:v,isDraftMode:S,prerenderManifest:O,routerServerContext:$,isOnDemandRevalidate:C,revalidateOnlyGenerated:x,resolvedPathname:A,clientReferenceManifest:I,serverActionsManifest:D}=s,b=(0,d.normalizeAppPath)(n),P=!!(O.dynamicRoutes[b]||O.routes[A]),k=async()=>((null==$?void 0:$.render404)?await $.render404(e,t,v,!1):t.end("This page could not be found"),null);if(P&&!S){let e=!!O.routes[A],t=O.dynamicRoutes[b];if(t&&!1===t.fallback&&!e){if(T.experimental.adapterPath)return await k();throw new w.NoFallbackError}}let L=null;!P||N.isDev||S||(L=A,L="/index"===L?"/":L);let q=!0===N.isDev||!P,U=P&&!q;D&&I&&(0,l.setManifestsSingleton)({page:n,clientReferenceManifest:I,serverActionsManifest:D});let H=e.method||"GET",M=(0,i.getTracer)(),j=M.getActiveScopeSpan(),G={params:y,prerenderManifest:O,renderOpts:{experimental:{authInterrupts:!!T.experimental.authInterrupts},cacheComponents:!!T.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:T.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n,r)=>N.onRequestError(e,t,n,r,$)},sharedContext:{buildId:f}},F=new u.NodeNextRequest(e),W=new u.NodeNextResponse(t),K=c.NextRequestAdapter.fromNodeNextRequest(F,(0,c.signalFromNodeResponse)(t));try{let s=async e=>N.handle(K,G).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=M.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${H} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${n}`)}),l=!!(0,o.getRequestMeta)(e,"minimalMode"),d=async o=>{var i,d;let u=async({previousCacheEntry:r})=>{try{if(!l&&C&&x&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(o);e.fetchMetrics=G.renderOpts.fetchMetrics;let i=G.renderOpts.pendingWaitUntil;i&&a.waitUntil&&(a.waitUntil(i),i=void 0);let d=G.renderOpts.collectedTags;if(!P)return await (0,_.sendResponse)(F,W,n,G.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,E.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[R.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==G.renderOpts.collectedRevalidate&&!(G.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&G.renderOpts.collectedRevalidate,r=void 0===G.renderOpts.collectedExpire||G.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:G.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==r?void 0:r.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:C})},!1,$),t}},c=await N.handleResponse({req:e,nextConfig:T,cacheKey:L,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:x,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:l});if(!P)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",C?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,E.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&P||p.delete(R.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,m.getCacheControlHeader)(c.cacheControl)),await (0,_.sendResponse)(F,W,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};j?await d(j):await M.withPropagatedContext(e.headers,()=>M.trace(p.BaseServerSpan.handleRequest,{spanName:`${H} ${n}`,kind:i.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},d))}catch(t){if(t instanceof w.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:C})},!1,$),P)throw t;return await (0,_.sendResponse)(F,W,new Response(null,{status:500})),null}}e.s(["handler",()=>v,"patchFetch",()=>T,"routeModule",()=>N,"serverHooks",()=>$,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>O]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_698282b7._.js.map